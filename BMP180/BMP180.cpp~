#include "Arduino.h"
#include "Wire.h"
#include "BMP180.h"


void BMP180::begin(){
   _temperature = 0;
   _pressure = 0;
   AC1 = readInt(0xAA);
   AC2 = readInt(0xAC);
   AC3 = readInt(0xAE);
   AC4 = readUInt(0xB0);
   AC5 = readUInt(0xB2);
   AC6 = readUInt(0xB4);
   B_1 = readInt(0xB6);
   B2  = readInt(0xB8);
   MB  = readInt(0xBA);
   MC  = readInt(0xBC);
   MD  = readInt(0xBE);
   
   
  c3 = 160.0 * pow(2,-15) * AC3;
  c4 = pow(10,-3) * pow(2,-15) * AC4;
  b1 = pow(160,2) * pow(2,-30) * B_1;
  c5 = (pow(2,-15) / 160) * AC5;
  c6 = AC6;
  mc = (pow(2,11) / pow(160,2)) * MC;
  md = MD / 160.0;
  x0 = AC1;
  x1 = 160.0 * pow(2,-13) * AC2;
  x2 = pow(160,2) * pow(2,-25) * B2;
  y0 = c4 * pow(2,15);
  y1 = c4 * c3;
  y2 = c4 * b1;
  p0 = (3791.0 - 8.0) / 1600.0;
  p1 = 1.0 - 7357.0 * pow(2,-20);
  p2 = 3038.0 * 100.0 * pow(2,-36);
  
}

void BMP180::read(){
	readTemp();
	readPressure();
}

void BMP180::readTemp(){
  Wire.beginTransmission(0x77);
  unsigned char bytes[2];
  bytes[0] = 0xF4;
  bytes[1] = 0x2E;
  Wire.write(bytes,2); 
  delay(5);
  int error = Wire.endTransmission();
  Wire.beginTransmission(0x77);
  Wire.write(0xF6);
  error = Wire.endTransmission();
  Wire.requestFrom(0x77, 2);
  unsigned char buffer[2];
  int bufferNumber = 0;
  
  while(Wire.available()){
    buffer[bufferNumber] = Wire.read();
    bufferNumber++;
  }

  double tu = (buffer[0] * 256.0) + buffer[1];
  double a = _c5 * (tu - _c6);
  _temperature = a + (_mc / (a + _md));
}

void BMP180::readPressure(){
  Wire.beginTransmission(0x77);
  unsigned char bytes[2];
  bytes[0] = 0xF4;
  bytes[1] = 0xF4;
  Wire.write(bytes,2); 
  delay(26);
  int error = Wire.endTransmission();
  Wire.beginTransmission(0x77);
  Wire.write(0xF6);
  error = Wire.endTransmission();
  Wire.requestFrom(0x77, 3);
  unsigned char buffer[3];
  int bufferNumber = 0;
  
  while(Wire.available()){
    buffer[bufferNumber] = Wire.read();
    bufferNumber++;
  }
  
  double s, x, y, z;
  double uncompensatedPressure = (buffer[0]*256.0) + buffer[1] + (buffer[2]/256.0);
  
  
  s = _temperature - 25.0;
  x = (_x2 * pow(s,2)) + (_x1 * s) + _x0;
  y = (_y2 * pow(s,2)) + (_y1 * s) + _y0;
  z = (uncompensatedPressure - x) / y;
  _pressure = (_p2 * pow(z,2)) + (_p1 * z) + _p0;
}

double BMP180::getTemp(){
  return _temperature; 
}

double BMP180::getPressure(){
  return _pressure; 
}

void BMP180::setTemp(double temp){
  _temperature = temp;
}

int BMP180::readInt(char address){
  Wire.beginTransmission(0x77);
  Wire.write(address);
  Wire.endTransmission();
  Wire.requestFrom(0x77, 2);
  int buffer[2];
  int bufferNumber = 0;
  
  while(Wire.available()){
    buffer[bufferNumber] = Wire.read();
    bufferNumber++;
  }
  return (buffer[0]<<8)|(buffer[1]);
}

unsigned int BMP180::readUInt(char address){
  Wire.beginTransmission(0x77);
  Wire.write(address);
  int error = Wire.endTransmission();
  Wire.requestFrom(0x77, 2);
  int buffer[2];
  int bufferNumber = 0;
  
  while(Wire.available()){
    buffer[bufferNumber] = Wire.read();
    bufferNumber++;
  }
  return (buffer[0]<<8)|(buffer[1]);
}
